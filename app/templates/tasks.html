{% extends "base.html" %}
{% block content %}
<h2>{% if preselected_project_id %}–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É –≤ –ø—Ä–æ–µ–∫—Ç–µ{% else %}–í–∞—à–∏ –∑–∞–¥–∞—á–∏{% endif %}</h2>

{% if preselected_project_id %}
    {% set selected_project = preselected_project_id %}
{% else %}
    <div style="margin:10px 0;">
        <a href="#" onclick="document.getElementById('new-task-form').classList.remove('hidden'); return false;">+ –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</a>
        |
        <a href="{{ url_for('main.tasks') }}">–í—Å–µ</a>
        | <a href="{{ url_for('main.tasks', status='todo') }}">–ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é</a>
        | <a href="{{ url_for('main.tasks', status='in_progress') }}">–í —Ä–∞–±–æ—Ç–µ</a>
        | <a href="{{ url_for('main.tasks', status='review') }}">–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</a>
        | <a href="{{ url_for('main.tasks', status='done') }}">–ì–æ—Ç–æ–≤–æ</a>
        | <a href="{{ url_for('main.tasks', overdue='true') }}">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ</a>
        | <a href="{{ url_for('main.tasks', due_today='true') }}">–°–µ–≥–æ–¥–Ω—è</a>
    </div>
{% endif %}

<div id="new-task-form" class="{% if preselected_project_id %}{% else %}hidden{% endif %}">
    <h3>{% if preselected_project_id %}–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É{% else %}–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É{% endif %}</h3>
    <form method="post" action="{{ url_for('main.new_task') }}">
        <p><input type="text" name="title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" required></p>
        <p><textarea name="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea></p>
        
        <p>
            <label>–ü—Ä–æ–µ–∫—Ç:</label>
            <select name="project_id">
                <option value="0">–ë–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞</option>
                {% for p in projects %}
                <option value="{{ p.id }}" {% if preselected_project_id and p.id == preselected_project_id %}selected{% endif %}>{{ p.name }}</option>
                {% endfor %}
            </select>
        </p>
        
        <p>
            <label>–°—Ç–∞—Ç—É—Å:</label>
            <select name="status">
                <option value="todo">–ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é</option>
                <option value="in_progress">–í —Ä–∞–±–æ—Ç–µ</option>
                <option value="review">–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</option>
                <option value="done">–ì–æ—Ç–æ–≤–æ</option>
            </select>
        </p>
        
        <p>
            <label>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</label>
            <select name="priority">
                <option value="1">üü¢ –ù–∏–∑–∫–∏–π</option>
                <option value="2" selected>üü° –°—Ä–µ–¥–Ω–∏–π</option>
                <option value="3">üü† –í—ã—Å–æ–∫–∏–π</option>
                <option value="4">üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π</option>
            </select>
        </p>
        
        <p>
            <label>–î–µ–¥–ª–∞–π–Ω:</label>
            <input type="date" name="deadline">
        </p>
        
        <p><strong>–ù–∞–∑–Ω–∞—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º:</strong></p>
        {% for user in users %}
            {% if current_user.can_assign_to(user) %}
                <label style="display:flex; align-items:center; margin:4px 0;">
                    <input type="checkbox" name="assignees" value="{{ user.id }}" style="margin-right:8px; width:16px; height:16px;">
                    {{ user.username }} (L{{ user.access_level }})
                </label>
            {% endif %}
        {% endfor %}
        
        <button type="submit" style="margin-top:10px;">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
        {% if not preselected_project_id %}
            <button type="button" onclick="document.getElementById('new-task-form').classList.add('hidden')">–û—Ç–º–µ–Ω–∞</button>
        {% endif %}
    </form>
</div>

{% if not preselected_project_id %}
    {% if tasks %}
    <div style="display:grid; gap:15px;">
    {% for task in tasks %}
        <div class="task-card {% if task.is_overdue() %}task-overdue{% endif %}">
            <a href="{{ url_for('main.view_task', id=task.id) }}" style="text-decoration:none; color:black;">
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div style="flex:1; min-width:0;">
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
                            <span style="color:{% if task.project %}{{ task.project.color }}{% else %}#7f8c8d{% endif %};">
                                {% if task.project %}[{{ task.project.name }}]{% endif %}
                            </span>
                            <strong style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">{{ task.get_priority_emoji() }} {{ task.title }}</strong>
                        </div>
                    </div>
                    <div style="text-align:right; min-width:120px;">
                        {% if task.deadline %}
                            <div style="font-size:0.9em; color:{% if task.is_overdue() %}red{% else %}#7f8c8d{% endif %}; margin-bottom:4px;">
                                üìÖ {{ task.deadline.strftime('%d.%m') }}
                            </div>
                        {% endif %}
                        <div style="font-size:0.9em; color:{{ task.get_status_color() }};">
                            {{ task.get_status_display() }}
                        </div>
                    </div>
                </div>
            </a>
        </div>
    {% endfor %}
    </div>
    {% else %}
    <p>–ù–µ—Ç –∑–∞–¥–∞—á.</p>
    {% endif %}
{% endif %}
{% endblock %}